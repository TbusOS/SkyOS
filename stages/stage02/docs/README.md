# 阶段二：ARM异常处理与中断

## 🎯 学习目标

通过本阶段的学习，学生将深入理解ARM32异常处理机制和中断控制系统：

1. **ARM异常模型深入理解**
   - ARM处理器模式和异常级别
   - 异常向量表的具体实现
   - 异常进入和退出流程
   - 寄存器组织和银行寄存器

2. **中断控制器(GIC)原理**
   - ARM Generic Interrupt Controller架构
   - 中断源、中断号、中断优先级
   - GIC分发器和CPU接口
   - 中断使能、屏蔽和确认机制

3. **系统调用机制**
   - SVC(软件中断)指令原理
   - 系统调用号传递机制
   - 用户态到内核态的切换
   - 系统调用表和分发机制

4. **定时器中断处理**
   - ARM Generic Timer架构
   - 定时器配置和中断生成
   - 周期性中断处理
   - 时间片调度基础

## 📚 理论知识概述

### ARM异常处理机制

#### 异常类型和优先级

ARM32支持7种异常类型，按优先级从高到低：

| 优先级 | 异常类型 | 描述 | 进入模式 |
|--------|----------|------|----------|
| 1 | Reset | 复位异常 | Supervisor |
| 2 | Data Abort | 数据访问异常 | Abort |
| 3 | FIQ | 快速中断请求 | FIQ |
| 4 | IRQ | 中断请求 | IRQ |
| 5 | Prefetch Abort | 预取指令异常 | Abort |
| 6 | SVC | 软件中断 | Supervisor |
| 7 | Undefined Instruction | 未定义指令 | Undefined |

#### 异常处理流程

1. **异常发生时的硬件操作**：
   - 保存当前PC到对应模式的LR
   - 保存当前CPSR到对应模式的SPSR
   - 禁用IRQ中断 (FIQ除外)
   - 切换到对应的处理器模式
   - 跳转到异常向量表对应地址

2. **异常处理程序的任务**：
   - 保存通用寄存器上下文
   - 执行异常处理逻辑
   - 恢复通用寄存器上下文
   - 返回到被中断程序

### ARM Generic Interrupt Controller (GIC)

#### GIC架构组件

```
         +----------------+
         |  Interrupt     |
         |  Sources       |
         +----------------+
                 |
         +----------------+
         |   Distributor  |  <- 中断分发器
         |   (GICD)       |
         +----------------+
                 |
         +----------------+
         |  CPU Interface |  <- CPU接口
         |   (GICC)       |
         +----------------+
                 |
         +----------------+
         |   ARM Core     |
         +----------------+
```

#### 中断类型

- **SGI (Software Generated Interrupt)**: ID 0-15，软件生成中断
- **PPI (Private Peripheral Interrupt)**: ID 16-31，私有外设中断
- **SPI (Shared Peripheral Interrupt)**: ID 32-1019，共享外设中断

### 系统调用实现

#### SVC指令机制

```assembly
@ 用户程序调用系统调用
mov r0, #1          @ 系统调用号
mov r1, #msg        @ 参数1
svc #0              @ 触发软件中断

@ SVC异常处理程序
svc_handler:
    @ 获取系统调用号
    ldr r0, [lr, #-4]   @ 从SVC指令中提取立即数
    bic r0, r0, #0xFF000000  @ 清除高位，得到系统调用号
    
    @ 调用系统调用分发函数
    bl  syscall_dispatch
    
    @ 返回用户程序
    movs pc, lr
```

## 🧪 实验内容规划

### 实验2.1：完善异常向量表
- 实现完整的异常处理程序框架
- 添加异常信息输出和调试功能
- 验证各种异常的触发和处理

### 实验2.2：实现定时器中断
- 配置ARM Generic Timer
- 实现定时器中断处理程序
- 添加简单的时间统计功能

### 实验2.3：系统调用机制
- 实现SVC异常处理程序
- 创建系统调用表和分发机制
- 实现基础系统调用 (如打印、退出等)

### 实验2.4：中断控制器编程
- 理解GIC寄存器接口
- 实现中断使能和屏蔽机制
- 多中断源的管理和处理

## 🎯 学习成果

完成本阶段后，学生将获得：

1. **深入的异常处理理解** - 掌握ARM异常模型的完整机制
2. **实际的中断编程能力** - 能够编写中断处理程序
3. **系统调用实现技能** - 理解操作系统服务接口
4. **定时器编程经验** - 为任务调度打下基础

## 🔗 与其他阶段的关系

- **承接阶段1**: 在基础启动的基础上添加异常处理
- **为阶段3准备**: 异常处理是内存管理的基础
- **为阶段4铺垫**: 中断机制是进程调度的核心

## 📋 技术要求

### 硬件环境
- ARM Cortex-A15 (QEMU virt machine)
- ARM Generic Interrupt Controller v2
- ARM Generic Timer

### 软件工具
- arm-none-eabi-gcc 交叉编译器
- QEMU ARM系统仿真器
- GDB调试器

### 技能前提
- 完成阶段1的学习
- 理解ARM汇编语言基础
- 熟悉C语言编程

通过系统学习本阶段内容，学生将为后续的内存管理、进程调度等高级主题打下坚实的基础。 