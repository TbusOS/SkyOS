# ARM64å¼€å‘å·¥å…·ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£æä¾›ARM64å¼€å‘æ‰€éœ€çš„å·¥å…·é“¾å®‰è£…ã€é…ç½®å’Œä½¿ç”¨æ–¹æ³•ï¼ŒåŒ…æ‹¬äº¤å‰ç¼–è¯‘å™¨ã€è°ƒè¯•å™¨ã€QEMUæ¨¡æ‹Ÿå™¨ç­‰æ ¸å¿ƒå¼€å‘å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ã€‚

## ğŸ› ï¸ å·¥å…·é“¾å®‰è£…

### macOSç¯å¢ƒ (æ¨è)

#### ä½¿ç”¨Homebrewå®‰è£…

```bash
# æ›´æ–°Homebrew
brew update

# å®‰è£…ARM64äº¤å‰ç¼–è¯‘å·¥å…·é“¾
brew install aarch64-elf-gcc

# å®‰è£…QEMUæ¨¡æ‹Ÿå™¨
brew install qemu

# å®‰è£…è®¾å¤‡æ ‘ç¼–è¯‘å™¨
brew install dtc

# å®‰è£…å…¶ä»–æœ‰ç”¨å·¥å…·
brew install binutils
brew install gdb
```

#### éªŒè¯å®‰è£…

```bash
# éªŒè¯ç¼–è¯‘å™¨
aarch64-none-elf-gcc --version
aarch64-none-elf-as --version
aarch64-none-elf-ld --version

# éªŒè¯QEMU
qemu-system-aarch64 --version

# éªŒè¯è®¾å¤‡æ ‘ç¼–è¯‘å™¨
dtc --version
```

### Linuxç¯å¢ƒ

#### Ubuntu/Debian

```bash
# æ›´æ–°åŒ…ç®¡ç†å™¨
sudo apt update

# å®‰è£…ARM64å·¥å…·é“¾
sudo apt install gcc-aarch64-linux-gnu
sudo apt install binutils-aarch64-linux-gnu

# å®‰è£…QEMU
sudo apt install qemu-system-arm

# å®‰è£…è®¾å¤‡æ ‘ç¼–è¯‘å™¨
sudo apt install device-tree-compiler

# å®‰è£…GDB
sudo apt install gdb-multiarch
```

#### CentOS/RHEL

```bash
# å¯ç”¨EPELä»“åº“
sudo yum install epel-release

# å®‰è£…å·¥å…·é“¾
sudo yum install gcc-aarch64-linux-gnu
sudo yum install qemu-system-aarch64

# ä»æºç ç¼–è¯‘dtc (å¦‚æœåŒ…ä¸å¯ç”¨)
git clone https://git.kernel.org/pub/scm/utils/dtc/dtc.git
cd dtc
make && sudo make install
```

## ğŸ”§ äº¤å‰ç¼–è¯‘å™¨è¯¦è§£

### ARM64-ELFå·¥å…·é“¾

```bash
# ç¼–è¯‘å™¨å¥—ä»¶
aarch64-none-elf-gcc     # C/C++ç¼–è¯‘å™¨
aarch64-none-elf-g++     # C++ç¼–è¯‘å™¨
aarch64-none-elf-as      # æ±‡ç¼–å™¨
aarch64-none-elf-ld      # é“¾æ¥å™¨
aarch64-none-elf-objcopy # ç›®æ ‡æ–‡ä»¶è½¬æ¢
aarch64-none-elf-objdump # åæ±‡ç¼–å™¨
aarch64-none-elf-nm      # ç¬¦å·æŸ¥çœ‹å™¨
aarch64-none-elf-size    # å¤§å°åˆ†æå™¨
aarch64-none-elf-strip   # ç¬¦å·å‰¥ç¦»å™¨
```

### ç¼–è¯‘å™¨é€‰é¡¹è¯¦è§£

#### CPUå’Œæ¶æ„é€‰é¡¹

```bash
# æŒ‡å®šCPUå‹å·
-mcpu=cortex-a57        # Cortex-A57
-mcpu=cortex-a72        # Cortex-A72
-mcpu=cortex-a73        # Cortex-A73
-mcpu=generic           # é€šç”¨ARM64

# æŒ‡å®šæ¶æ„ç‰ˆæœ¬
-march=armv8-a          # ARMv8-AåŸºç¡€æ¶æ„
-march=armv8.1-a        # ARMv8.1-A
-march=armv8.2-a        # ARMv8.2-A

# æŒ‡å®šè°ƒä¼˜ç›®æ ‡
-mtune=cortex-a57       # é’ˆå¯¹A57ä¼˜åŒ–
-mtune=generic          # é€šç”¨ä¼˜åŒ–
```

#### ä»£ç ç”Ÿæˆé€‰é¡¹

```bash
# åŸºç¡€é€‰é¡¹
-ffreestanding          # ç‹¬ç«‹ç¯å¢ƒç¼–è¯‘
-nostdlib              # ä¸é“¾æ¥æ ‡å‡†åº“
-nostartfiles          # ä¸ä½¿ç”¨é»˜è®¤å¯åŠ¨æ–‡ä»¶

# æ ˆå’Œå®‰å…¨é€‰é¡¹
-fno-stack-protector   # ç¦ç”¨æ ˆä¿æŠ¤
-fno-builtin           # ç¦ç”¨å†…å»ºå‡½æ•°
-fno-common           # ç¦ç”¨é€šç”¨å—

# ä¼˜åŒ–é€‰é¡¹
-O0                    # æ— ä¼˜åŒ–ï¼Œä¾¿äºè°ƒè¯•
-O1                    # åŸºç¡€ä¼˜åŒ–
-O2                    # æ ‡å‡†ä¼˜åŒ–ï¼ˆæ¨èï¼‰
-O3                    # æ¿€è¿›ä¼˜åŒ–
-Os                    # å¤§å°ä¼˜åŒ–
```

#### è°ƒè¯•é€‰é¡¹

```bash
# è°ƒè¯•ä¿¡æ¯
-g                     # ç”Ÿæˆè°ƒè¯•ä¿¡æ¯
-g3                    # è¯¦ç»†è°ƒè¯•ä¿¡æ¯
-gdwarf-2             # DWARF2æ ¼å¼
-gdwarf-4             # DWARF4æ ¼å¼

# è­¦å‘Šé€‰é¡¹
-Wall                  # å¸¸è§è­¦å‘Š
-Wextra               # é¢å¤–è­¦å‘Š
-Werror               # è­¦å‘Šå½“ä½œé”™è¯¯
-Wpedantic            # ä¸¥æ ¼æ ‡å‡†æ£€æŸ¥
```

### é“¾æ¥å™¨ä½¿ç”¨

#### åŸºæœ¬é“¾æ¥

```bash
# åŸºæœ¬é“¾æ¥å‘½ä»¤
aarch64-none-elf-ld -T linker.lds -o output.elf input1.o input2.o

# å¸¸ç”¨é“¾æ¥é€‰é¡¹
-T script.lds          # æŒ‡å®šé“¾æ¥è„šæœ¬
-nostdlib             # ä¸é“¾æ¥æ ‡å‡†åº“
-static               # é™æ€é“¾æ¥
-Map=output.map       # ç”Ÿæˆå†…å­˜æ˜ å°„æ–‡ä»¶
```

#### é“¾æ¥è„šæœ¬ç¤ºä¾‹

```ld
/* å®Œæ•´çš„é“¾æ¥è„šæœ¬ç¤ºä¾‹ */
ENTRY(_start)

MEMORY
{
    ROM (rx)  : ORIGIN = 0x00000000, LENGTH = 1M
    RAM (rwx) : ORIGIN = 0x40000000, LENGTH = 256M
}

SECTIONS
{
    .text : {
        *(.vectors)
        *(.text*)
        *(.rodata*)
        . = ALIGN(8);
    } > RAM
    
    .data : {
        __data_start = .;
        *(.data*)
        __data_end = .;
        . = ALIGN(8);
    } > RAM
    
    .bss : {
        __bss_start = .;
        *(.bss*)
        *(COMMON)
        __bss_end = .;
        . = ALIGN(8);
    } > RAM
    
    /DISCARD/ : {
        *(.note*)
        *(.comment)
        *(.ARM.attributes)
    }
}
```

## ğŸ–¥ï¸ QEMUä½¿ç”¨è¯¦è§£

### åŸºæœ¬QEMUå‘½ä»¤

```bash
# åŸºæœ¬å¯åŠ¨å‘½ä»¤
qemu-system-aarch64 -machine virt -cpu cortex-a57 -m 256M -nographic -kernel kernel.bin

# å‚æ•°è¯´æ˜
-machine virt          # ä½¿ç”¨virtè™šæ‹Ÿæœº
-cpu cortex-a57       # æŒ‡å®šCPUå‹å·
-m 256M               # å†…å­˜å¤§å°
-nographic            # æ— å›¾å½¢ç•Œé¢
-kernel kernel.bin    # å†…æ ¸æ–‡ä»¶
```

### é«˜çº§QEMUé€‰é¡¹

#### è°ƒè¯•é€‰é¡¹

```bash
# GDBè°ƒè¯•æ”¯æŒ
qemu-system-aarch64 \
    -machine virt \
    -cpu cortex-a57 \
    -m 256M \
    -nographic \
    -kernel kernel.bin \
    -s \                  # GDBæœåŠ¡å™¨ç«¯å£1234
    -S                    # å¯åŠ¨æ—¶æš‚åœ

# æŒ‡å®šè°ƒè¯•ç«¯å£
qemu-system-aarch64 ... -gdb tcp::1234

# ç›‘æ§æ¨¡å¼
qemu-system-aarch64 ... -monitor stdio
```

#### è®¾å¤‡å’Œå¤–è®¾

```bash
# ä¸²å£é‡å®šå‘
-serial stdio          # ä¸²å£è¾“å‡ºåˆ°æ ‡å‡†è¾“å…¥è¾“å‡º
-serial file:output.txt # ä¸²å£è¾“å‡ºåˆ°æ–‡ä»¶
-serial tcp:localhost:4444,server # TCPä¸²å£æœåŠ¡å™¨

# å­˜å‚¨è®¾å¤‡
-drive file=disk.img,format=raw,if=virtio
-cdrom cdimage.iso

# ç½‘ç»œè®¾å¤‡
-netdev user,id=net0 -device virtio-net-pci,netdev=net0
```

#### ä¿¡æ¯æŸ¥è¯¢

```bash
# å¯åŠ¨ç›‘æ§æ¨¡å¼
qemu-system-aarch64 -monitor stdio

# ç›‘æ§å‘½ä»¤
(qemu) info registers    # æŸ¥çœ‹å¯„å­˜å™¨
(qemu) info memory       # æŸ¥çœ‹å†…å­˜
(qemu) info mtree        # æŸ¥çœ‹å†…å­˜æ ‘
(qemu) info qtree        # æŸ¥çœ‹è®¾å¤‡æ ‘
(qemu) x/10x 0x40000000  # æŸ¥çœ‹å†…å­˜å†…å®¹
```

### è®¾å¤‡æ ‘ç”Ÿæˆå’Œåˆ†æ

```bash
# ç”Ÿæˆè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶
qemu-system-aarch64 -machine virt -cpu cortex-a57 -machine dumpdtb=virt.dtb

# è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
dtc -I dtb -O dts virt.dtb > virt.dts

# åˆ†æè®¾å¤‡æ ‘
grep -A 10 "compatible" virt.dts  # æŸ¥çœ‹å…¼å®¹è®¾å¤‡
grep -A 5 "reg = " virt.dts       # æŸ¥çœ‹å¯„å­˜å™¨åœ°å€
grep -A 5 "interrupts" virt.dts   # æŸ¥çœ‹ä¸­æ–­é…ç½®
```

## ğŸ› è°ƒè¯•å·¥å…·ä½¿ç”¨

### GDBè°ƒè¯•

#### å¯åŠ¨è°ƒè¯•ä¼šè¯

```bash
# ç»ˆç«¯1: å¯åŠ¨QEMUè°ƒè¯•æ¨¡å¼
qemu-system-aarch64 -machine virt -cpu cortex-a57 -m 256M -nographic \
    -kernel kernel.elf -s -S

# ç»ˆç«¯2: å¯åŠ¨GDB
aarch64-none-elf-gdb kernel.elf
```

#### GDBåŸºæœ¬å‘½ä»¤

```gdb
# è¿æ¥QEMU
(gdb) target remote localhost:1234

# åŸºæœ¬æ§åˆ¶
(gdb) continue          # ç»§ç»­æ‰§è¡Œ
(gdb) step             # å•æ­¥æ‰§è¡Œ
(gdb) next             # ä¸‹ä¸€è¡Œ
(gdb) finish           # æ‰§è¡Œåˆ°å‡½æ•°è¿”å›

# æ–­ç‚¹ç®¡ç†
(gdb) break main       # åœ¨mainå‡½æ•°è®¾ç½®æ–­ç‚¹
(gdb) break *0x40000000 # åœ¨åœ°å€è®¾ç½®æ–­ç‚¹
(gdb) info breakpoints # æŸ¥çœ‹æ–­ç‚¹
(gdb) delete 1         # åˆ é™¤æ–­ç‚¹1

# å†…å­˜å’Œå¯„å­˜å™¨
(gdb) info registers   # æŸ¥çœ‹æ‰€æœ‰å¯„å­˜å™¨
(gdb) print $x0        # æŸ¥çœ‹X0å¯„å­˜å™¨
(gdb) x/10x 0x40000000 # æŸ¥çœ‹å†…å­˜
(gdb) set $x0 = 0x1234 # è®¾ç½®å¯„å­˜å™¨å€¼
```

#### ARM64ç‰¹å®šè°ƒè¯•

```gdb
# æŸ¥çœ‹ARM64å¯„å­˜å™¨
(gdb) info registers general    # é€šç”¨å¯„å­˜å™¨
(gdb) info registers system     # ç³»ç»Ÿå¯„å­˜å™¨
(gdb) info registers vector     # å‘é‡å¯„å­˜å™¨

# æŸ¥çœ‹å¼‚å¸¸çº§åˆ«
(gdb) print/x $currentel

# æŸ¥çœ‹å¼‚å¸¸å‘é‡è¡¨
(gdb) print/x $vbar_el1

# åæ±‡ç¼–
(gdb) disassemble main
(gdb) disassemble $pc,$pc+40
```

### LLDBè°ƒè¯• (macOS)

```lldb
# å¯åŠ¨LLDB
lldb kernel.elf

# è¿æ¥QEMU
(lldb) gdb-remote localhost:1234

# åŸºæœ¬å‘½ä»¤
(lldb) continue
(lldb) step
(lldb) next

# æ–­ç‚¹
(lldb) breakpoint set --name main
(lldb) breakpoint set --address 0x40000000

# å¯„å­˜å™¨å’Œå†…å­˜
(lldb) register read
(lldb) register read x0
(lldb) memory read 0x40000000
```

## ğŸ“Š åˆ†æå·¥å…·

### ç›®æ ‡æ–‡ä»¶åˆ†æ

```bash
# æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶ä¿¡æ¯
aarch64-none-elf-objdump -h kernel.elf     # æ®µä¿¡æ¯
aarch64-none-elf-objdump -t kernel.elf     # ç¬¦å·è¡¨
aarch64-none-elf-objdump -d kernel.elf     # åæ±‡ç¼–

# æŸ¥çœ‹æ–‡ä»¶å¤§å°
aarch64-none-elf-size kernel.elf

# æŸ¥çœ‹æ–‡ä»¶æ ¼å¼
file kernel.elf
aarch64-none-elf-readelf -h kernel.elf     # ELFå¤´ä¿¡æ¯
```

### æ€§èƒ½åˆ†æ

```bash
# ç”Ÿæˆè°ƒç”¨å›¾
aarch64-none-elf-objdump -d kernel.elf | grep "bl\|b\..*" > calls.txt

# åˆ†æä»£ç å¤§å°
aarch64-none-elf-nm --size-sort kernel.elf | tail -20

# æ£€æŸ¥æ ˆä½¿ç”¨
aarch64-none-elf-objdump -d kernel.elf | grep -E "(sub|add).*sp"
```

## ğŸ”¨ Makefileæœ€ä½³å®è·µ

### å®Œæ•´çš„Makefileç¤ºä¾‹

```makefile
# ARM64 é¡¹ç›® Makefile
ARCH := arm64
TARGET := aarch64-none-elf

# å·¥å…·é“¾
CC := $(TARGET)-gcc
AS := $(TARGET)-as
LD := $(TARGET)-ld
OBJCOPY := $(TARGET)-objcopy
OBJDUMP := $(TARGET)-objdump
GDB := $(TARGET)-gdb

# ç¼–è¯‘é€‰é¡¹
CFLAGS := -mcpu=cortex-a57 -ffreestanding -nostdlib -nostartfiles
CFLAGS += -Wall -Wextra -g -O2 -fno-stack-protector
ASFLAGS := -mcpu=cortex-a57 -g
LDFLAGS := -T linker.lds -nostdlib

# ç›®å½•
SRCDIR := src
BUILDDIR := build
INCDIR := include

# æ–‡ä»¶
SOURCES := $(wildcard $(SRCDIR)/*.c) $(wildcard $(SRCDIR)/*.S)
OBJECTS := $(SOURCES:$(SRCDIR)/%=$(BUILDDIR)/%.o)
TARGET_ELF := $(BUILDDIR)/kernel.elf
TARGET_BIN := $(BUILDDIR)/kernel.bin

# QEMUé…ç½®
QEMU := qemu-system-aarch64
QEMU_FLAGS := -machine virt -cpu cortex-a57 -m 256M -nographic
QEMU_DEBUG := $(QEMU_FLAGS) -s -S

# é»˜è®¤ç›®æ ‡
.PHONY: all clean run debug help

all: $(TARGET_BIN)

# åˆ›å»ºæ„å»ºç›®å½•
$(BUILDDIR):
	mkdir -p $(BUILDDIR)

# ç¼–è¯‘è§„åˆ™
$(BUILDDIR)/%.c.o: $(SRCDIR)/%.c | $(BUILDDIR)
	$(CC) $(CFLAGS) -I$(INCDIR) -c $< -o $@

$(BUILDDIR)/%.S.o: $(SRCDIR)/%.S | $(BUILDDIR)
	$(AS) $(ASFLAGS) -c $< -o $@

# é“¾æ¥
$(TARGET_ELF): $(OBJECTS)
	$(LD) $(LDFLAGS) $^ -o $@

# ç”ŸæˆäºŒè¿›åˆ¶
$(TARGET_BIN): $(TARGET_ELF)
	$(OBJCOPY) -O binary $< $@

# è¿è¡Œ
run: $(TARGET_BIN)
	$(QEMU) $(QEMU_FLAGS) -kernel $<

# è°ƒè¯•
debug: $(TARGET_ELF)
	@echo "Starting QEMU in debug mode..."
	@echo "In another terminal run: $(GDB) $<"
	@echo "Then connect with: target remote localhost:1234"
	$(QEMU) $(QEMU_DEBUG) -kernel $(TARGET_BIN)

# åæ±‡ç¼–
disasm: $(TARGET_ELF)
	$(OBJDUMP) -d $< > $(BUILDDIR)/kernel.disasm

# æ¸…ç†
clean:
	rm -rf $(BUILDDIR)

# å¸®åŠ©
help:
	@echo "Available targets:"
	@echo "  all    - Build kernel"
	@echo "  run    - Run in QEMU"
	@echo "  debug  - Run in debug mode"
	@echo "  disasm - Generate disassembly"
	@echo "  clean  - Clean build files"
```

## ğŸš€ å¸¸è§é—®é¢˜è§£å†³

### ç¼–è¯‘é—®é¢˜

**é—®é¢˜**: æ‰¾ä¸åˆ°å·¥å…·é“¾
```bash
# è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥PATH
echo $PATH
which aarch64-none-elf-gcc

# æ‰‹åŠ¨æ·»åŠ åˆ°PATH
export PATH="/usr/local/bin:$PATH"
```

**é—®é¢˜**: é“¾æ¥é”™è¯¯
```bash
# æ£€æŸ¥é“¾æ¥è„šæœ¬è¯­æ³•
aarch64-none-elf-ld --verbose

# æŸ¥çœ‹è¯¦ç»†é“¾æ¥ä¿¡æ¯
aarch64-none-elf-ld -Map=link.map ...
```

### QEMUé—®é¢˜

**é—®é¢˜**: QEMUå¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥QEMUæ”¯æŒçš„æœºå™¨ç±»å‹
qemu-system-aarch64 -machine help

# æ£€æŸ¥CPUç±»å‹
qemu-system-aarch64 -cpu help
```

**é—®é¢˜**: æ— æ³•è¿æ¥GDB
```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -an | grep 1234

# å°è¯•ä¸åŒç«¯å£
qemu-system-aarch64 ... -gdb tcp::1235
```

### è°ƒè¯•é—®é¢˜

**é—®é¢˜**: è°ƒè¯•ç¬¦å·ä¸åŒ¹é…
```bash
# ç¡®ä¿ä½¿ç”¨ç›¸åŒçš„ELFæ–‡ä»¶
file kernel.elf
aarch64-none-elf-objdump -h kernel.elf

# æ£€æŸ¥è°ƒè¯•ä¿¡æ¯
aarch64-none-elf-objdump -g kernel.elf
```

## ğŸ“š è¿›é˜¶æŠ€å·§

### è‡ªåŠ¨åŒ–è„šæœ¬

```bash
#!/bin/bash
# è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•è„šæœ¬

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "Building ARM64 kernel..."
make clean
make all

echo "Running tests..."
timeout 10 make run > test_output.txt 2>&1 &
QEMU_PID=$!

sleep 5
if kill -0 $QEMU_PID 2>/dev/null; then
    echo "Kernel is running successfully"
    kill $QEMU_PID
else
    echo "Kernel failed to start"
    cat test_output.txt
    exit 1
fi

echo "Tests passed!"
```

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§

```bash
# ç”Ÿæˆä¼˜åŒ–æŠ¥å‘Š
aarch64-none-elf-gcc -O2 -fopt-info-all kernel.c

# åˆ†æä»£ç çƒ­ç‚¹
aarch64-none-elf-objdump -d kernel.elf | \
    grep -E "bl|b\." | sort | uniq -c | sort -nr

# æ£€æŸ¥å¯¹é½
aarch64-none-elf-objdump -h kernel.elf | grep -E "ALIGN|align"
```

é€šè¿‡æŒæ¡è¿™äº›å·¥å…·çš„ä½¿ç”¨æ–¹æ³•ï¼Œå­¦ç”Ÿå°†èƒ½å¤Ÿé«˜æ•ˆåœ°è¿›è¡ŒARM64æ“ä½œç³»ç»Ÿå¼€å‘ï¼Œä»ç¼–è¯‘è°ƒè¯•åˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œå…¨é¢æå‡å¼€å‘æŠ€èƒ½ã€‚ 