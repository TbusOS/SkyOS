# 实验01: ARM32启动与基础IO

## 🎯 实验目标

通过本实验，学生将：
1. 理解ARM32处理器的启动过程
2. 掌握ARM汇编语言基础
3. 学会配置ARM异常向量表
4. 实现基本的UART串口输出
5. 理解ARM处理器模式和寄存器

## 📚 理论背景

### ARM32架构基础

ARM32是一种RISC架构，具有以下特点：
- **32位指令集**: 每条指令固定32位长度
- **多种处理器模式**: User、System、Supervisor、IRQ、FIQ、Abort、Undefined
- **丰富的寄存器**: R0-R15，其中R13=SP，R14=LR，R15=PC
- **条件执行**: 大部分指令可以条件执行
- **移位操作**: 可在一条指令中完成数据处理和移位

### ARM处理器模式

| 模式 | 编码 | 用途 | 特权级别 |
|------|------|------|----------|
| User | 10000 | 用户程序 | 非特权 |
| FIQ | 10001 | 快速中断 | 特权 |
| IRQ | 10010 | 普通中断 | 特权 |
| Supervisor | 10011 | 系统调用/复位 | 特权 |
| Abort | 10111 | 内存访问异常 | 特权 |
| Undefined | 11011 | 未定义指令 | 特权 |
| System | 11111 | 特权用户模式 | 特权 |

### 异常向量表

ARM处理器的异常向量表固定位置存放各种异常的处理入口：

```
地址       异常类型
0x00       复位 (Reset)
0x04       未定义指令 (Undefined Instruction)  
0x08       软件中断 (Software Interrupt)
0x0C       预取指令异常 (Prefetch Abort)
0x10       数据访问异常 (Data Abort)
0x14       保留
0x18       IRQ中断
0x1C       FIQ中断
```

## 🛠️ 实验环境

### 软件要求
- Ubuntu 20.04 或更新版本
- ARM交叉编译工具链: `gcc-arm-none-eabi`
- QEMU ARM系统模拟器: `qemu-system-arm`
- 文本编辑器 (VS Code推荐)

### 环境搭建
```bash
# 安装必要工具
sudo apt-get update
sudo apt-get install gcc-arm-none-eabi qemu-system-arm make

# 验证安装
arm-none-eabi-gcc --version
qemu-system-arm --version

# 克隆代码仓库
git clone https://github.com/your-repo/SkyOS.git
cd SkyOS
```

## 📋 实验步骤

### 步骤1: 理解项目结构

查看项目目录结构：
```bash
tree SkyOS/
```

重点理解以下文件：
- `boot/start.S`: ARM启动汇编代码
- `boot/boot.lds`: 链接脚本
- `kernel/main.c`: C语言主函数
- `Makefile`: 构建脚本

### 步骤2: 分析启动代码

打开 `boot/start.S`，逐行理解：

```assembly
.section .vectors, "ax"
.global _vectors
_vectors:
    ldr pc, =reset_handler      @ 0x00: Reset
    ldr pc, =undef_handler      @ 0x04: Undefined Instruction
    ...
```

**思考题1**: 为什么要使用 `ldr pc, =address` 而不是直接 `b address`？

**思考题2**: 异常向量表为什么要放在固定地址？

### 步骤3: 理解处理器模式切换

分析启动代码中的模式切换：

```assembly
@ SVC模式 (Supervisor)
msr cpsr, #0x13     @ SVC mode, IRQ/FIQ disabled
ldr sp, =svc_stack_top
```

**思考题3**: 为什么要为每个处理器模式设置独立的堆栈？

### 步骤4: 编译和运行

```bash
# 检查工具链
make check-toolchain

# 编译内核
make all

# 在QEMU中运行
make run
```

预期输出：
```
======================================
    SkyOS - ARM32 教学操作系统
======================================
版本: 0.1.0 (教学演示版)
架构: ARM Cortex-A15
...
```

### 步骤5: 调试分析

在另一个终端窗口：
```bash
# 启动调试模式
make debug
```

在调试终端：
```bash
# 连接GDB
arm-none-eabi-gdb -ex 'target remote localhost:1234' build/skyos.elf

# GDB命令
(gdb) info registers
(gdb) disassemble _start
(gdb) break main
(gdb) continue
```

## 🔬 实验任务

### 任务1: 基础分析 (必做)

1. **启动过程分析**
   - 运行系统，记录完整的启动输出
   - 使用GDB查看启动时的寄存器状态
   - 分析处理器ID和CPSR寄存器的含义

2. **代码理解**
   - 解释BSS段清零的必要性
   - 说明各个堆栈的作用
   - 分析链接脚本的内存布局

### 任务2: 功能扩展 (必做)

1. **增加启动信息**
   - 在main函数中添加更多系统信息输出
   - 显示内存布局信息 (使用链接脚本中的符号)
   - 添加ARM特性检测 (如缓存大小等)

2. **改进输出格式**
   - 实现格式化数字输出函数 (十进制)
   - 添加字符串格式化功能 (简化版printf)
   - 美化启动界面

### 任务3: 深入探索 (选做)

1. **异常处理增强**
   - 实现简单的未定义指令异常处理
   - 添加异常信息输出
   - 测试不同类型的异常

2. **汇编优化**
   - 使用ARM条件执行特性优化代码
   - 实现更高效的字符串操作
   - 添加性能计数

## 📊 实验报告要求

### 报告结构

1. **实验概述** (10%)
   - 实验目的和环境
   - 完成的任务概述

2. **理论分析** (30%)
   - ARM32架构特点总结
   - 启动过程详细分析
   - 异常向量表机制说明

3. **实验过程** (40%)
   - 详细的实验步骤
   - 遇到的问题和解决方案
   - 关键代码分析

4. **结果分析** (15%)
   - 运行结果截图
   - 寄存器状态分析
   - 性能观察

5. **思考总结** (5%)
   - 对ARM架构的理解
   - 与x86架构的对比
   - 改进建议

### 提交要求

- **源代码**: 包含所有修改的源文件
- **可执行文件**: build目录下的编译结果
- **实验报告**: PDF格式，不超过15页
- **演示视频**: 3-5分钟的运行演示 (可选)

## 🤔 思考题解答

### 思考题1: 为什么使用ldr pc而不是b指令？

**答案**: 
- `b address` 是相对跳转，跳转范围有限 (±32MB)
- `ldr pc, =address` 是绝对跳转，可以跳转到任意地址
- 异常处理程序可能位于内存的任意位置，需要绝对跳转

### 思考题2: 异常向量表为什么要放在固定地址？

**答案**:
- ARM处理器硬件设计决定，异常发生时自动跳转到固定地址
- 这些地址是ARM架构规范的一部分
- 软件无法改变这些地址，只能在这些地址放置跳转指令

### 思考题3: 为什么要为每个模式设置独立堆栈？

**答案**:
- 不同模式有不同的特权级别和用途
- 独立堆栈避免数据污染和安全问题
- 异常处理时需要保存上下文，独立堆栈保证原始堆栈不被破坏
- 提高系统的可靠性和可调试性

## 🔗 参考资料

1. **ARM Architecture Reference Manual ARMv7-A**
   - ARM官方架构手册
   - 处理器模式和异常处理详解

2. **ARM Cortex-A Series Programmer's Guide**
   - Cortex-A系列编程指南
   - 启动代码最佳实践

3. **QEMU ARM System Emulation**
   - QEMU ARM虚拟机使用指南
   - virt machine内存布局

4. **GCC ARM嵌入式工具链文档**
   - 交叉编译环境配置
   - 链接脚本编写

## 📞 支持与帮助

- **讨论区**: 课程论坛实验01板块
- **答疑时间**: 每周三下午2-4点
- **邮箱支持**: skyos-help@university.edu
- **紧急联系**: 助教微信群

---

**注意事项**:
- 确保代码规范，添加充分注释
- 及时保存工作，使用Git版本控制
- 遇到问题先查看FAQ，再寻求帮助
- 鼓励小组讨论，但独立完成作业 